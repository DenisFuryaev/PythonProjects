# GRADED FUNCTION: scene_change_detector

def scene_change_detector(frames, threshold_pixel = 1000, threshold_luminance=0.1*1e8, threshold_edge=0.2*1e6, with_vis=False):
    scene_changes = []
    vis = []
    metric_values = []
    
    ### START CODE HERE ###
    # Ваши внешние переменные
    prev_frame = None
    metric_value_prev_lum = None
    metric_value_curr_lum = None
    edge_frame_prev = None
    edge_frame = None
    vote_edge = 0
    ###  END CODE HERE  ###
    
    for idx, frame in tqdm(enumerate(frames), leave=False):
        # frame - это кадр
        # idx - это номер кадра
        
        ### START CODE HERE ###
        # Основная часть вашего алгоритма
        
        metric_value_curr_lum = cv2.calcHist([cv2.cvtColor(frame, cv2.COLOR_RGB2YUV ) ],[0],None,[256],[0,256])
        
        luminance = cv2.cvtColor(frame, cv2.COLOR_RGB2YUV)[:, :, 0]
        edge_frame_x = cv2.Sobel(luminance,cv2.CV_64F,1,0,ksize=5)
        edge_frame_y = cv2.Sobel(luminance,cv2.CV_64F,0,1,ksize=5)
        edge_frame = np.sqrt(edge_frame_x**2 + edge_frame_y**2)
            
        if prev_frame is not None:
            # Находим расстояние между соседними кадрами
            
            metric_value_lum = np.mean((metric_value_prev_lum - metric_value_curr_lum)**2)
            vote_luminance = metric_value_lum > threshold_luminance
            
            metric_value_pixel = np.mean((frame.astype(np.int32) - prev_frame) ** 2)
            vote_pixel = metric_value_pixel > threshold_pixel
            
            if ((vote_luminance and not(vote_pixel)) or (not(vote_luminance) and vote_pixel)):
                # Есть разногласие голосов
                metric_value_edge = np.mean((edge_frame.astype(np.int32) - edge_frame_prev) ** 2)
                vote_edge = metric_value_edge < threshold_edge
            
            if (vote_luminance and vote_pixel) or ((vote_luminance or vote_pixel) and vote_edge):
                scene_changes.append(idx)
                if with_vis:
                    # Кадры в памяти занимают много места, поэтому сохраним лишь первые 100 срабатываний
                    if len(vis) < 100:
                        vis.append([prev_frame, frame])
            metric_values.append(metric_value_lum)
        else:
            metric_values.append(0)
        prev_frame = frame
        metric_value_prev_lum = metric_value_curr_lum
        edge_frame_prev = edge_frame
        
        ###  END CODE HERE  ###

    return scene_changes, vis, metric_values